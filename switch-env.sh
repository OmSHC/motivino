#!/bin/bash

# Enhanced script for development, production, and testing configurations

show_usage() {
    echo "Usage: $0 [dev|prod|test|backend|frontend|status|logs|clean]"
    echo ""
    echo "Commands:"
    echo "  dev      - Development environment (HTTP, hot reload)"
    echo "  prod     - Production environment (HTTPS, optimized)"
    echo "  test     - Show testing commands for isolated development"
    echo "  backend  - Start only backend + Redis (for API testing)"
    echo "  frontend - Start only frontend + Nginx (for UI testing)"
    echo "  status   - Show current container status"
    echo "  logs     - Show container logs"
    echo "  clean    - Clean up Docker resources"
    echo ""
    echo "Available Docker Compose files:"
    echo "  ğŸ“ docker-compose.yml           - Development (4 containers)"
    echo "  ğŸ“ docker-compose.prod.yml      - Production (4 containers)"
    echo "  ğŸ“ docker-compose.gcp.yml       - GCP deployment (3 containers)"
    echo "  ğŸ“ docker-compose.simple.yml    - Simple dev (2 containers)"
    echo "  ğŸ“ docker-compose.two-containers.yml - Combined app (2 containers)"
    echo ""
    echo "Database: SQLite (no PostgreSQL needed!)"
}

if [ "$1" = "dev" ]; then
    echo "ğŸ”§ DEVELOPMENT Environment Setup"
    echo "=================================="
    echo "   âœ… SQLite database (no PostgreSQL needed)"
    echo "   âœ… Redis for caching and sessions"
    echo "   âœ… Django backend + React frontend"
    echo "   âœ… Hot reload for frontend development"
    echo ""
    echo "ğŸ“ Using: docker-compose.yml"
    echo "ğŸŒ Frontend: http://localhost (nginx serves built React app)"
    echo "ğŸ”— Backend API: http://localhost/api"
    echo "ğŸ‘¤ Admin: http://localhost/admin"
    echo ""
    echo "ğŸš€ Quick start commands:"
    echo "   # Full development environment"
    echo "   docker-compose up --build"
    echo ""
    echo "   # Frontend development (hot reload)"
    echo "   cd frontend && npm start"
    echo "   # Then visit: http://localhost:3000"
    echo ""
    echo "ğŸ’¡ Tip: Use './switch-env.sh test' for isolated testing options"

elif [ "$1" = "prod" ]; then
    echo "ğŸš€ PRODUCTION Environment Setup"
    echo "================================="
    echo "   âœ… SQLite database (file-based)"
    echo "   âœ… Redis for caching and sessions"
    echo "   âœ… Optimized for GCP deployment"
    echo "   âœ… HTTPS with SSL certificates"
    echo ""
    echo "ğŸ“ Using: docker-compose.prod.yml"
    echo "ğŸŒ Access: https://your-domain.com"
    echo "ğŸ”— Backend API: https://your-domain.com/api"
    echo "ğŸ‘¤ Admin: https://your-domain.com/admin"
    echo ""
    echo "ğŸš€ Deployment commands:"
    echo "   # Full production deployment"
    echo "   docker-compose -f docker-compose.prod.yml up --build -d"
    echo ""
    echo "   # Check deployment status"
    echo "   docker-compose -f docker-compose.prod.yml ps"
    echo ""
    echo "   # View logs"
    echo "   docker-compose -f docker-compose.prod.yml logs -f"
    echo ""
    echo "ğŸ“¦ Alternative GCP deployment:"
    echo "   docker-compose -f docker-compose.gcp.yml pull"
    echo "   docker-compose -f docker-compose.gcp.yml up -d"
    echo ""
    echo "âš¡ Alternative 2-container deployment:"
    echo "   docker-compose -f docker-compose.two-containers.yml up --build -d"

elif [ "$1" = "test" ]; then
    echo "ğŸ§ª ISOLATED TESTING Environment"
    echo "==============================="
    echo "Test individual services without full stack dependencies"
    echo ""
    echo "ğŸ”¬ Testing Commands:"
    echo ""
    echo "   # Test backend API only (with Redis)"
    echo "   docker-compose up backend redis"
    echo "   # API available at: http://localhost:8000"
    echo "   # Test endpoints: http://localhost:8000/api/"
    echo ""
    echo "   # Test frontend UI only (with Nginx)"
    echo "   docker-compose up frontend nginx"
    echo "   # UI available at: http://localhost"
    echo "   # API calls will fail (expected for isolated testing)"
    echo ""
    echo "   # Full integration testing"
    echo "   docker-compose up --build"
    echo ""
    echo "   # Test with mock data"
    echo "   # Backend: Use Postman/Insomnia to test API endpoints"
    echo "   # Frontend: UI renders, API calls show network errors"
    echo ""
    echo "ğŸ¯ Testing Strategy:"
    echo "   1. Test backend isolated (API logic, database)"
    echo "   2. Test frontend isolated (UI rendering, user experience)"
    echo "   3. Test integration (full application flow)"
    echo ""
    echo "ğŸ’¡ Pro tip: Use different browser tabs for isolated testing"

elif [ "$1" = "backend" ]; then
    echo "ğŸ Starting BACKEND ONLY (with Redis)"
    echo "======================================"
    echo "   âœ… Backend API server"
    echo "   âœ… Redis cache"
    echo "   âŒ No frontend (for API testing only)"
    echo ""
    echo "ğŸš€ Command:"
    echo "   docker-compose up backend redis"
    echo ""
    echo "ğŸŒ Access points:"
    echo "   API: http://localhost:8000/api/"
    echo "   Admin: http://localhost:8000/admin/"
    echo "   Health: http://localhost:8000/api/core/health/"
    echo ""
    docker-compose up backend redis

elif [ "$1" = "frontend" ]; then
    echo "âš›ï¸ Starting FRONTEND ONLY (with Nginx)"
    echo "======================================"
    echo "   âœ… React frontend"
    echo "   âœ… Nginx web server"
    echo "   âŒ No backend (for UI testing only)"
    echo ""
    echo "ğŸš€ Command:"
    echo "   docker-compose up frontend nginx"
    echo ""
    echo "ğŸŒ Access points:"
    echo "   UI: http://localhost"
    echo "   # API calls will show network errors (expected)"
    echo ""
    docker-compose up frontend nginx

elif [ "$1" = "status" ]; then
    echo "ğŸ“Š Container Status"
    echo "==================="
    echo ""
    echo "ğŸ” Current running containers:"
    docker-compose ps 2>/dev/null || echo "No containers running"
    echo ""
    echo "ğŸ“ˆ Resource usage:"
    docker stats --no-stream 2>/dev/null || echo "Unable to get stats"
    echo ""
    echo "ğŸ’¾ Docker system usage:"
    docker system df 2>/dev/null || echo "Unable to get system info"

elif [ "$1" = "logs" ]; then
    echo "ğŸ“ Container Logs"
    echo "================="
    echo ""
    echo "Choose a service to view logs:"
    echo "  docker-compose logs backend"
    echo "  docker-compose logs frontend"
    echo "  docker-compose logs redis"
    echo "  docker-compose logs nginx"
    echo ""
    echo "Or view all logs:"
    echo "  docker-compose logs -f"
    echo ""
    echo "Recent logs from all services:"
    docker-compose logs --tail=20 2>/dev/null || echo "No containers running"

elif [ "$1" = "clean" ]; then
    echo "ğŸ§¹ Docker Cleanup"
    echo "================="
    echo ""
    echo "This will remove:"
    echo "  - Stopped containers"
    echo "  - Unused images"
    echo "  - Build cache"
    echo "  - Unused volumes"
    echo ""
    read -p "Are you sure you want to clean Docker resources? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "ğŸ§¹ Cleaning Docker resources..."
        docker-compose down 2>/dev/null || true
        docker system prune -f
        docker volume prune -f
        docker builder prune -a -f
        echo "âœ… Cleanup completed!"
    else
        echo "âŒ Cleanup cancelled."
    fi

else
    show_usage
fi
